<html>
<head>
</head>
<body>
	<h1 style="text-align:center"> HW4 </h1>
	<div style="text-align:center">Node.js, Shelljs, Native Methods</div>
	<hr>
	<div id="container" style="float:left; margin:3px; width:80vh; height:80vh">
	</div>
	<div style="float:left; margin-left: 10px; width:32vw;font-size:24px;">Current Configuration:<br/><br/>
	  Radius:<div id="slider" style="width:100%;"></div><br/>
	  Sound:<input id = "CSound"type="checkbox"style="width:24px;height:24px" checked><br/><br/>
	  <button id="toggle" style="width:100%; height:10%; text-align:center">Start/Pause</button>
	  說明: 滑鼠左鍵移動矩形，右鍵移動圓形
	  <p id='greeting'></p>
	</div>
	<audio id="collisionsound" style="display:none">
		<source src="https://linzunzhe.github.io/MV/W3D_hw/hw4/bgm.wav" type='audio/wav'>
	</audio>
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/94/three.min.js"></script>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script type="text/javascript">
	  document.oncontextmenu = function() {
		return false;
	  }
	</script>
	<script>
		var camera, scene, renderer, circle, circle2, radius = 5 ,box, st = true, Cst = true;
		var pos, vel;
		var motion = true;
		var mouse = new THREE.Vector2();
		var raycaster = new THREE.Raycaster();
		var sound = document.getElementById ('collisionsound');
		
		init();
		animate();
		
		$('#toggle').click ( function() {
			motion = !motion;
		});
		
		$('#CSound').click ( function() {
			Cst = !Cst;
		});
		$( function() {
			$( "#slider" ).slider({
				range: false,
				min: 3,
				max: 15,
				values: [5],
				slide: function( event, ui ) {
					scene.remove(circle);
					radius = ui.values[0];
					circle = new THREE.Mesh (new THREE.CircleGeometry (radius,20), new THREE.MeshBasicMaterial({color: 0xffff00}));
					scene.add (circle);
					circle.visible = st;
					scene.remove(circle2);
					circle2 = new THREE.Mesh (new THREE.CircleGeometry (radius,20), new THREE.MeshBasicMaterial({color: 0xff0000}));
					scene.add (circle2);
					circle2.visible = !st;
					circle.position.copy (pos);
					circle2.position.copy (pos);
				}
			});
		});

		function init() {
			window.addEventListener('mousedown', onDocumentMouseDown, false);
		  var ww = $("#container").innerWidth();
		  var hh = $("#container").innerHeight();
		  renderer = new THREE.WebGLRenderer();
		  renderer.setSize(ww, hh);
		  renderer.setClearColor(0x888888);
		  $("#container").append(renderer.domElement);
		  
		  ////////////////////////////////////////////////

		  scene = new THREE.Scene();
		  camera = new THREE.OrthographicCamera (-50,50,50,-50,1, 1000);
		  camera.position.z = 500;

			circle = new THREE.Mesh (new THREE.CircleGeometry (radius,20), new THREE.MeshBasicMaterial({color: 0xffff00}));
		  scene.add (circle);
		  
		  circle2 = new THREE.Mesh (new THREE.CircleGeometry (radius,20), new THREE.MeshBasicMaterial({color: 0xff0000}));
		  scene.add (circle2);
		  circle2.visible = false;
		  
		  box = new THREE.Mesh(new THREE.PlaneGeometry( 30, 15), new THREE.MeshBasicMaterial({color: 0x00ffff}));
		  scene.add (box);
		  box.position.set( 10, 10, -10);
		  
		  let geometry = new THREE.Geometry();
		  geometry.vertices.push(
			new THREE.Vector3(-40, -40, 0),
			new THREE.Vector3(40, -40, 0),
			new THREE.Vector3(40, 40, 0),
			new THREE.Vector3(-40, 40, 0),
			new THREE.Vector3(-40, -40, 0));

		  let border = new THREE.Line(geometry, new THREE.LineBasicMaterial({
			color: 0x0000ff
		  }));
		  scene.add(border);

		  pos = new THREE.Vector3();
		  vel = new THREE.Vector3(8,4,0);
		  window.addEventListener('resize', onWindowResize, false);
		}

		function onWindowResize() {
		  var ww = $("#container").innerWidth();
		  var hh = $("#container").innerHeight();

		  camera.aspect = ww / hh;
		  camera.updateProjectionMatrix();
		  renderer.setSize(ww, hh);
		}

		function animate() {
			dt = motion ? 0.1 : 0;
			pos.add (vel.clone().multiplyScalar(dt));
		  
			if (Math.abs(pos.x) > 40-radius) {
			vel.x *= -1;  	
		  }
			if (Math.abs(pos.y) > 40-radius) {
			vel.y *= -1;  	
		  }
		  circle.position.copy (pos);
		  circle2.position.copy (pos);
		  Check_Intersect(box.position.clone(), pos.clone(), radius);
		  
		  requestAnimationFrame(animate);
		  render();
		}

		function render() {
		  renderer.render(scene, camera);
		}
		
		function Check_Intersect() {
			let bMX = box.position.x + 15;
			let bMY = box.position.y + 7.5;
			let bmX = box.position.x - 15;
			let bmY = box.position.y - 7.5;
			let cX = pos.x;
			let cY = pos.y;
			$.ajaxSetup({async:false});
			$.get( "http://127.0.0.1:1337/api?bMX="+bMX+"&bMY="+bMY+"&bmX="+bmX+"&bmY="+bmY+"&cX="+cX+"&cY="+cY+"&r="+radius, function( data ) {
				if(data){
					if(data.output === "1"){
						st = false;
						circle.visible = false;
						circle2.visible = true;
						if(Cst){sound.play();console.log("123")}
						$('#greeting').text("Collision!");
					}
					else if(data.output === "0"){
						st = true;
						circle.visible = true;
						circle2.visible = false;
						$('#greeting').text("");
					}
				}
			});
		}
		
		function onDocumentMouseDown(event) {
			var viewportPos =$('#container').get(0).getBoundingClientRect(); 
			mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
			mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;
			raycaster.setFromCamera(mouse, camera);
			if(event.button === 0) {
				if(mouse.x < 1){
					let x = 0.8 - ( 15 / 50);
					let y = 0.8 - (7.5 / 50);
					if(mouse.x < -x)mouse.x = -x;
					if(mouse.x > x)mouse.x = x;
					if(mouse.y < -y)mouse.y = -y;
					if(mouse.y > y)mouse.y = y;
					box.position.set( mouse.x * 50, mouse.y * 50, -10);
				}
			}
			else if(event.button === 2) {
				let r = 0.8 - ( radius / 50);
				if(mouse.x < -r)mouse.x = -r;
				if(mouse.x > r)mouse.x = r;
				if(mouse.y < -r)mouse.y = -r;
				if(mouse.y > r)mouse.y = r;
				pos.x = mouse.x * 50;
				pos.y = mouse.y * 50;
				circle.position.copy (pos);
				circle2.position.copy (pos);
			}
		}
	</script>
</body>
</html>